---
title: 여러 엑셀 파일 한 번에 합치기
author: Rvinci
description: 지역별로 나뉜 엑셀 파일을 하나씩 열어 복사해 붙이느라 시간을 쓰고 계신가요? 폴더에 들어 있는 여러 엑셀 파일을 한 번에 읽고, 하나의 테이블로 합치는 방법을 소개합니다.
excerpt: 지역별로 나뉜 엑셀 파일을 하나씩 열어 복사해 붙이느라 시간을 쓰고 계신가요? 폴더에 들어 있는 여러 엑셀 파일을 한 번에 읽고, 하나의 테이블로 합치는 방법을 소개합니다.
categories: [data]
tags: [r, tidyverse, list.files, lapply, bind_rows]
published: true
---

지역별로 나뉜 엑셀 파일을 받으면, 보통은 파일을 하나씩 열어서 복사해
붙이는 방식으로 데이터를 모으게 됩니다. 그런데 파일이 몇 개만 늘어나도
작업이 고단해집니다. R에서는 폴더에 있는 파일을 한 번에 읽고, 같은
규칙으로 정리한 뒤, 하나의 테이블로 간단히 합칠 수 있습니다.

관광지식정보시스템의 [주요관광지점 입장객
통계](https://know.tour.go.kr/stat/visitStatDis/table.do) 자료를 예로
들어 서울, 경기, 인천 파일을 합쳐 하나의 테이블로 만드는 과정을
보여드리겠습니다.

## 데이터 준비하기

먼저 필요한 패키지를 로드합니다. 그리고 파일을 합치기 전에, 데이터
구조가 어떤지 하나만 먼저 확인해 두는 편이 안전합니다. 여기서는 서울
파일을 열어 앞부분을 살펴보겠습니다. 데이터를 보면 칼럼명이 첫 번째
행에만 있는 게 아니라 두 번째 행에도 들어가 있습니다. 이런 형태는 그대로
병합하면 열이 어긋나기 쉬워서, 데이터를 읽을 때 ’어느 행부터가 진짜
데이터인지’를 지정해 주는 처리가 필요합니다.

``` r
# 패키지 로드
library(tidyverse)
library(readxl)

# 확인용 데이터 로드
tmp <- read_xls("데이터/수도권 주요관광지점 입장객/주요관광지점 입장객_서울_2023.xls")

# 데이터 확인
head(tmp)
```

    ## # A tibble: 6 × 6
    ##   시도       군구   관광지 `내/외국인`    총계 `(2023년 ~ 2023년)`
    ##   <chr>      <chr>  <chr>  <chr>         <dbl> <chr>              
    ## 1 <NA>       <NA>   <NA>   <NA>             NA 2023년             
    ## 2 서울특별시 종로구 경복궁 내국인      4485430 4485430            
    ## 3 서울특별시 종로구 경복궁 외국인      1094475 1094475            
    ## 4 서울특별시 종로구 경복궁 합계        5579905 5579905            
    ## 5 서울특별시 종로구 종묘   내국인       272304 272304             
    ## 6 서울특별시 종로구 종묘   외국인        66629 66629

## 폴더 안의 파일 목록 가져오기

이제 폴더에 들어 있는 엑셀 파일을 한 번에 모읍니다. `list.files()`를
사용하면 특정 폴더에서 원하는 확장자만 골라 파일 목록을 만들 수
있습니다. `full.names = TRUE`를 주면 전체 경로가 들어가서, 이후에
`read_xls()`로 바로 읽을 수 있습니다.

``` r
# 데이터 폴더 경로
folder_path <- "데이터/수도권 주요관광지점 입장객"

# 확장자가 .xls인 파일 목록 가져오기
file_list <- list.files(folder_path, pattern = "\\.xls$", full.names = TRUE)

# 파일 목록 확인
file_list
```

    ## [1] "데이터/수도권 주요관광지점 입장객/주요관광지점 입장객_경기_2023.xls"  
    ## [2] "데이터/수도권 주요관광지점 입장객/주요관광지점 입장객_서울_2023.xls"  
    ## [3] "데이터/수도권 주요관광지점 입장객/주요관광지점 입장객_인천_2023.xls"

## 파일을 같은 규칙으로 정리한 뒤 합치기

이제부터는 파일마다 똑같은 작업을 반복합니다. ‘읽기 → 필요한 열만 남기기
→ 칼럼명 통일하기’ 순서로 정리한 결과를 차곡차곡 쌓아 하나의 테이블로
합치겠습니다.

수동으로 한다면 파일을 하나 열고, 필요한 행과 열을 고르고, 칼럼명을 바꾼
뒤 저장하는 일을 파일 개수만큼 반복해야 합니다. 이 과정을 자동으로 바꿔
주는 게 `lapply()`와 그 안에 들어가는 `function(file) { ... }`입니다.
파일 목록만 만들어 두면, 나머지는 ’각 파일에 대해 같은 규칙을 적용’하는
방식으로 한 번에 끝낼 수 있습니다.

`lapply()`는 리스트(또는 벡터)의 각 원소에 함수를 적용하고, 결과를
리스트로 돌려주는 함수입니다. 여기서 `file_list`는 파일 경로가 들어 있는
문자 벡터이고, `function(file)`은 파일 경로 하나를 입력으로 받아 정리된
데이터프레임 하나를 반환하는 함수입니다. 그래서 `lapply()`가 실제로 하는
일은 아래처럼 이해하면 됩니다.

1.  `file_list`의 첫 번째 경로를 `file`에 넣고 함수를 실행합니다.
2.  그 결과를 리스트의 1번째 칸에 저장합니다.
3.  이걸 n번째 반복한 뒤 데이터프레임들의 리스트를 반환합니다.

즉, 아래 코드는 파일을 하나씩 수동으로 처리하는 대신, 파일 개수만큼 자동
반복해서 결과를 모아 줍니다.

여기서 중요한 부분은 `skip = 1`입니다. 앞에서 확인한 것처럼 칼럼명이 두
줄로 들어가 있는 구조라면, 두 번째 행부터 읽어야 실제 데이터가
안정적으로 들어옵니다. 그리고 파일마다 열 이름이 조금씩 다를 수 있으니,
병합 전에 칼럼명을 한 번에 통일해 두는 것이 좋습니다. 그래야
`bind_rows()`가 같은 열끼리 정확히 붙여 줍니다.

``` r
# 모든 파일 읽고 가공
all_data <- lapply(file_list, function(file) {
  read_xls(file, skip = 1) %>%  # 두 번째 행부터 읽기
    select(1:5) %>%                   # 필요한 열 선택
    setNames(c("시도", "시군구", "관광지", "구분", "총계")) %>% # 칼럼명 지정 
    mutate(구분 = as.character(구분))
})

# 하나로 병합
united_data <- bind_rows(all_data)

# 데이터 확인
head(united_data)
```

    ## # A tibble: 6 × 5
    ##   시도   시군구 관광지                     구분     총계
    ##   <chr>  <chr>  <chr>                      <chr>   <dbl>
    ## 1 경기도 수원시 kbs수원센터(kbs수원아트홀) 내국인  19612
    ## 2 경기도 수원시 kbs수원센터(kbs수원아트홀) 합계    19612
    ## 3 경기도 수원시 경기대학교소성박물관       내국인  18150
    ## 4 경기도 수원시 경기대학교소성박물관       합계    18150
    ## 5 경기도 수원시 서수원칠보체육관           내국인 113703
    ## 6 경기도 수원시 서수원칠보체육관           합계   113703

이제 서울, 경기, 인천처럼 파일로 나뉘어 있던 데이터가 하나의 테이블로
합쳐졌습니다. 이 상태가 되면 지역별 합계, 관광지 순위, 특정 조건만
필터링 등의 작업을 파일마다 반복할 필요가 없습니다.

같은 구조의 엑셀 파일을 자주 사용한다면, 파일을 ’하나씩 열어서 처리’하는
방식 대신 ’폴더에서 한 번에 읽어 병합’하는 방법을 시도해 보세요!