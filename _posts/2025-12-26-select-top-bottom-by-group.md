---
title: 그룹별 상하위 데이터 추출하기
author: Rvinci
description: 그룹별로 값이 큰 항목과 작은 항목을 매번 손으로 정리하고 계신가요? 이 글에서는 그룹별 상·하위 값을 자동으로 추출하고 바로 활용 가능한 요약표로 정리하는 방법을 다룹니다.
excerpt: 그룹별로 값이 큰 항목과 작은 항목을 매번 손으로 정리하고 계신가요? 이 글에서는 그룹별 상·하위 값을 자동으로 추출하고 바로 활용 가능한 요약표로 정리하는 방법을 다룹니다.
categories: [data]
tags: [r, tidyverse, data-processing, data-summary]
published: true
output:
  md_document:
    variant: markdown_github
    preserve_yaml: true
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, 
  encoding = encoding, 
  output_file=paste0(Sys.Date(), "-", sub(".Rmd", ".md",inputFile)), 
  output_dir = "C:/Users/minyoung/projects/ggsave/docs/데이터 가공 팁") })
---

이번에는 2023년 시군구별 주민등록인구 데이터를 가지고 분석을 진행해봅니다.  
각 시도별로 사람이 가장 많이 모여 사는 시군구 3곳과  
조금은 한적한 시군구 3곳을 골라내는 작업입니다.

단순히 데이터를 추출하기만 하면 섭섭하니,  
결과를 한눈에 볼 수 있도록 표까지 만들어보겠습니다.

데이터는 통계청의 [시군구별 주민등록인구 데이터](https://kosis.kr/statHtml/statHtml.do?orgId=101&tblId=DT_1YL20651E&vw_cd=MT_GTITLE01&list_id=101&scrId=&seqNo=&lang_mode=ko&obj_var_id=&itm_id=&conn_path=MT_GTITLE01&path=%252FstatisticsList%252FstatisticsListIndex.do)를 사용합니다.

데이터 구성은 단순합니다.
- 시도
- 시군구
- 주민등록인구수

필요한 재료는 다 모았으니, 이제 R에서 불러옵니다.

```r
# 패키지 로드
library(tidyverse)
library(readxl)

# 데이터 로드
data <- read_xlsx("데이터/주민등록인구_시도_시군구_2023.xlsx", skip=1)

# 데이터 확인
head(data)
```

    ## # A tibble: 6 × 3
    ##   `행정구역별(1)` `행정구역별(2)` `계 (명)`
    ##   <chr>           <chr>               <dbl>
    ## 1 전국            소계             51325329
    ## 2 서울특별시      소계              9386034
    ## 3 서울특별시      종로구             139417
    ## 4 서울특별시      중구               121312
    ## 5 서울특별시      용산구             213151
    ## 6 서울특별시      성동구             277361

데이터를 열어보면,  
익숙한 행정구역 이름들과 함께 인구수가 보입니다.

분석을 시작하기 전에,  
```rename```으로 칼럼 이름부터 사람이 읽기 좋은 형태로 바꿔줍니다.  
그리고 ```filter```로 전국 합계나 소계처럼  
이번 분석에서는 불필요한 값들은 제거해줍니다.

```mutate```를 이용해 세종시는 시군구가 따로 없다는 점도  
이 김에 같이 처리해 줍니다.

```r
data2 <- data %>% 
  rename(시도 = `행정구역별(1)`,
         시군구 = `행정구역별(2)`,
         주민등록인구수 = `계 (명)`) %>% 
  filter(시도 != "전국",
         (시도 == "세종특별자치시")|(시군구 != "소계")) %>% 
  mutate(시군구 = case_when(시도 == "세종특별자치시" ~ "세종특별자치시",
                         T ~ 시군구))

head(data2)
```

    ## # A tibble: 6 × 3
    ##   시도       시군구   주민등록인구수
    ##   <chr>      <chr>             <dbl>
    ## 1 서울특별시 종로구           139417
    ## 2 서울특별시 중구             121312
    ## 3 서울특별시 용산구           213151
    ## 4 서울특별시 성동구           277361
    ## 5 서울특별시 광진구           335554
    ## 6 서울특별시 동대문구         341149

이제야 비로소 분석하기에 괜찮은 데이터가 되었습니다.

## 시도별 주민등록인구 수 상위 3개 시군구 추출하기

이제 본격적으로 사람이 많이 사는 곳을 찾아봅니다.  
```slice_max```는 이름 그대로,
많은 쪽부터 잘라주는 함수입니다.

시도별로 묶은 뒤,  
주민등록인구 수 기준 상위 3개를 뽑아봅니다.

```r
pop_high <- data2 %>% 
  group_by(시도) %>% 
  slice_max(order_by = 주민등록인구수, n = 3)

pop_high
```

    ## # A tibble: 48 × 3
    ## # Groups:   시도 [17]
    ##    시도           시군구     주민등록인구수
    ##    <chr>          <chr>               <dbl>
    ##  1 강원특별자치도 원주시             361503
    ##  2 강원특별자치도 춘천시             286426
    ##  3 강원특별자치도 강릉시             209439
    ##  4 경기도         수원시            1197257
    ##  5 경기도         용인시            1075566
    ##  6 경기도         고양시            1074907
    ##  7 경상남도       통합창원시        1009038
    ##  8 경상남도       김해시             533659
    ##  9 경상남도       양산시             355122
    ## 10 경상북도       포항시             493033
    ## # ℹ 38 more rows

결과를 보면,  
"역시 이 동네" 싶은 곳들도 있고,  
"여기가 이렇게 많았나?" 싶은 곳들도 보입니다.  

## 시도별 주민등록인구 수 하위 3개 시군구 추출하기

이번에는 반대로,  
조금은 조용한(?) 지역들을 살펴봅니다.  
방법은 거의 동일하고, ```slice_max```가 아닌 ```slice_min```을 사용하면 됩니다.

``` r
pop_low <- data2 %>% 
  group_by(시도) %>% 
  slice_min(order_by = 주민등록인구수, n = 3)

pop_low
```

    ## # A tibble: 48 × 3
    ## # Groups:   시도 [17]
    ##    시도           시군구 주민등록인구수
    ##    <chr>          <chr>           <dbl>
    ##  1 강원특별자치도 양구군          21056
    ##  2 강원특별자치도 화천군          23007
    ##  3 강원특별자치도 고성군          27305
    ##  4 경기도         연천군          41584
    ##  5 경기도         가평군          62302
    ##  6 경기도         과천시          81000
    ##  7 경상남도       의령군          25475
    ##  8 경상남도       산청군          33752
    ##  9 경상남도       함양군          36945
    ## 10 경상북도       울릉군           9077
    ## # ℹ 38 more rows

## 상·하위 3개 시군구 요약표 만들기

이제 결과를 보고서에 바로 넣을 수 있는 표로 바꿔볼 차례입니다.  
상위 3곳, 하위 3곳을 각각  
'지역명(인구수)' 형태의 문자열로 만든 뒤,  
시도별로 한 줄에 정리합니다.

이를 위해 먼저 ```paste0```를 사용해  
각 시군구를 '시군구명(인구수)' 형태의 문자열로 만듭니다.  
이때 ```scales::comma```를 함께 사용해  
인구 수에 천 단위 구분기호를 추가하면,  
보기 좋게 숫자를 보여 수 있습니다.

다음으로 ```group_by(시도)```를 통해 시도별로 데이터를 묶은 뒤,  
```summarise``` 안에서 다시 한 번 ```paste0```를 사용해  
상위 3개 시군구 정보를 쉼표로 연결된 하나의 문자열로 정리합니다.

이렇게 하면
- 시도당 한 행만 남고
- 각 행에는 상·하위 시군구 정보가 깔끔하게 요약되어

보고서나 슬라이드에 그대로 옮겨 쓰기 좋은 형태의 표가 만들어집니다.

``` r
library(scales)

pop_high_sum <- pop_high %>% 
  mutate(`상위 3개 시군구`=paste0(시군구,
                           "(",
                           comma(주민등록인구수, suffix="명"),
                           ")")
         ) %>% 
  group_by(시도) %>% 
  summarise(`상위 3개 시군구` = paste0(`상위 3개 시군구`, collapse=", "))

pop_high_sum
```

    ## # A tibble: 17 × 2
    ##    시도           `상위 3개 시군구`                                            
    ##    <chr>          <chr>                                                        
    ##  1 강원특별자치도 원주시(361,503명), 춘천시(286,426명), 강릉시(209,439명)      
    ##  2 경기도         수원시(1,197,257명), 용인시(1,075,566명), 고양시(1,074,907명)
    ##  3 경상남도       통합창원시(1,009,038명), 김해시(533,659명), 양산시(355,122명)
    ##  4 경상북도       포항시(493,033명), 구미시(405,506명), 경산시(266,205명)      
    ##  5 광주광역시     북구(421,683명), 광산구(396,741명), 서구(283,991명)          
    ##  6 대구광역시     달서구(527,781명), 북구(419,624명), 수성구(407,331명)        
    ##  7 대전광역시     서구(464,634명), 유성구(366,845명), 중구(223,256명)          
    ##  8 부산광역시     해운대구(380,448명), 부산진구(359,508명), 사하구(297,831명)  
    ##  9 서울특별시     송파구(654,166명), 강서구(563,058명), 강남구(544,873명)      
    ## 10 세종특별자치시 세종특별자치시(386,525명)                                    
    ## 11 울산광역시     남구(307,232명), 울주군(218,997명), 북구(216,477명)          
    ## 12 인천광역시     서구(624,358명), 부평구(494,138명), 남동구(492,415명)        
    ## 13 전라남도       순천시(278,137명), 여수시(271,696명), 목포시(214,156명)      
    ## 14 전북특별자치도 전주시(642,727명), 익산시(270,036명), 군산시(259,980명)      
    ## 15 제주특별자치도 제주시(491,654명), 서귀포시(183,598명)                       
    ## 16 충청남도       천안시(655,959명), 아산시(345,796명), 서산시(176,011명)      
    ## 17 충청북도       통합청주시(852,189명), 충주시(207,778명), 제천시(130,194명)

하위 3개 시군구에 대해서도 같은 방식으로 정리해줍니다.

``` r
pop_low_sum <- pop_low %>% 
  mutate(`하위 3개 시군구`=paste0(시군구,
                           "(",
                           comma(주민등록인구수, suffix="명"),
                           ")")
         ) %>% 
  group_by(시도) %>% 
  summarise(`하위 3개 시군구` = paste0(`하위 3개 시군구`, collapse=", "))

pop_low_sum
```

    ## # A tibble: 17 × 2
    ##    시도           `하위 3개 시군구`                                    
    ##    <chr>          <chr>                                                
    ##  1 강원특별자치도 양구군(21,056명), 화천군(23,007명), 고성군(27,305명) 
    ##  2 경기도         연천군(41,584명), 가평군(62,302명), 과천시(81,000명) 
    ##  3 경상남도       의령군(25,475명), 산청군(33,752명), 함양군(36,945명) 
    ##  4 경상북도       울릉군(9,077명), 영양군(15,661명), 청송군(24,019명)  
    ##  5 광주광역시     동구(107,176명), 남구(209,646명), 서구(283,991명)    
    ##  6 대구광역시     군위군(22,988명), 중구(89,064명), 남구(139,187명)    
    ##  7 대전광역시     대덕구(169,853명), 동구(217,628명), 중구(223,256명)  
    ##  8 부산광역시     중구(38,619명), 동구(87,792명), 서구(104,089명)      
    ##  9 서울특별시     중구(121,312명), 종로구(139,417명), 용산구(213,151명)
    ## 10 세종특별자치시 세종특별자치시(386,525명)                            
    ## 11 울산광역시     동구(152,287명), 중구(208,668명), 북구(216,477명)    
    ## 12 인천광역시     옹진군(20,377명), 동구(59,482명), 강화군(69,005명)   
    ## 13 전라남도       구례군(24,314명), 곡성군(26,905명), 진도군(28,979명) 
    ## 14 전북특별자치도 장수군(20,983명), 무주군(23,251명), 진안군(24,465명) 
    ## 15 제주특별자치도 서귀포시(183,598명), 제주시(491,654명)               
    ## 16 충청남도       청양군(30,168명), 계룡시(46,667명), 서천군(49,116명) 
    ## 17 충청북도       단양군(27,701명), 보은군(31,010명), 괴산군(36,590명)

마지막으로 `left_join`을 사용해 상하위 결과를 하나의 표로 합쳐줍니다.

``` r
pop_sum <- pop_high_sum %>% 
  left_join(pop_low_sum, by="시도")

pop_sum
```

    ## # A tibble: 17 × 3
    ##    시도           `상위 3개 시군구`                            `하위 3개 시군구`
    ##    <chr>          <chr>                                        <chr>            
    ##  1 강원특별자치도 원주시(361,503명), 춘천시(286,426명), 강릉…  양구군(21,056명)…
    ##  2 경기도         수원시(1,197,257명), 용인시(1,075,566명), …  연천군(41,584명)…
    ##  3 경상남도       통합창원시(1,009,038명), 김해시(533,659명),… 의령군(25,475명)…
    ##  4 경상북도       포항시(493,033명), 구미시(405,506명), 경산…  울릉군(9,077명),…
    ##  5 광주광역시     북구(421,683명), 광산구(396,741명), 서구(28… 동구(107,176명),…
    ##  6 대구광역시     달서구(527,781명), 북구(419,624명), 수성구(… 군위군(22,988명)…
    ##  7 대전광역시     서구(464,634명), 유성구(366,845명), 중구(22… 대덕구(169,853명…
    ##  8 부산광역시     해운대구(380,448명), 부산진구(359,508명), …  중구(38,619명), …
    ##  9 서울특별시     송파구(654,166명), 강서구(563,058명), 강남…  중구(121,312명),…
    ## 10 세종특별자치시 세종특별자치시(386,525명)                    세종특별자치시(3…
    ## 11 울산광역시     남구(307,232명), 울주군(218,997명), 북구(21… 동구(152,287명),…
    ## 12 인천광역시     서구(624,358명), 부평구(494,138명), 남동구(… 옹진군(20,377명)…
    ## 13 전라남도       순천시(278,137명), 여수시(271,696명), 목포…  구례군(24,314명)…
    ## 14 전북특별자치도 전주시(642,727명), 익산시(270,036명), 군산…  장수군(20,983명)…
    ## 15 제주특별자치도 제주시(491,654명), 서귀포시(183,598명)       서귀포시(183,598…
    ## 16 충청남도       천안시(655,959명), 아산시(345,796명), 서산…  청양군(30,168명)…
    ## 17 충청북도       통합청주시(852,189명), 충주시(207,778명), …  단양군(27,701명)…

이번 글에서는  
시도별로 주민등록인구 수 상위 3개, 하위 3개 시군구를 추출하고  
이를 하나의 요약표로 정리하는 방법을 살펴봤습니다.

인구 데이터뿐만 아니라  
매출, 이용자 수, 건수 데이터 등  
웬만한 데이터에 그대로 적용할 수 있습니다.

엑셀로 하려면  
정렬 → 복사 → 붙여넣기 → 확인 → 다시 정렬…  
이 과정에서 한 번 실수라도 했다가는  
대참사로 이어지기 쉽습니다.

R은 이런 반복 작업에 특히 강합니다.  
한 번 코드를 만들어두면  
데이터가 바뀌어도 3초면 정리된 표를 바로 확인할 수 있습니다.