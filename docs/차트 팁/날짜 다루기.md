---
layout: post_comments
title: 날짜 다루기
parent: 차트 팁
published: true
---

# {{ page.title }}
{: .no_toc }

## 목차
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## 사전 작업

시계열 데이터(time-series data)를 이용하여 도표를 그릴 때 날짜를 다뤄야
하는 경우가 있습니다. 시계열 데이터는 동일한 개체에 대해 일정한 시간
간격으로 수집된 데이터를 의미합니다. 2018\~2020년 코스피 지수 변화,
2020년 1월\~12월 시도별 인구수 변화 등이 일반적으로 접하는 시계열
데이터라고 할 수 있습니다.

그런데 날짜를 다루는 작업이 왜 까다로울까요?

-   날짜를 표현하는 방식이 다양합니다(예: “2020-08-08”, “2020/08/08”,
    “20-08-08”, “2020년 8월 8일” 등)
-   날짜에는 순서가 있는데, 문자형(character) 데이터로 날짜를 불러오면
    abc순이나 123순으로 나열되어서 순서가 엉망이 됩니다
-   날짜는 일반적인 숫자형(numerical) 데이터와 달라서, 두 날짜 사이의
    기간을 ‘+’나’-’ 연산으로 계산할 수 없습니다

`lubridate` 패키지를 이용하면, R로 날짜-시간 자료(date-time data)를 더
쉽게 다룰 수 있습니다. `lubridate`에 대한 소개는
[웹페이지](https://lubridate.tidyverse.org/reference/lubridate-package.html)를
참고해 주세요.

이번에는 우리나라 코로나19 확진자 수 추이를 도표로 그려보겠습니다.
국가별 코로나19 확진자 수 데이터는 [Our World in
Data](https://ourworldindata.org/covid-vaccinations?country=OWID_WRL)에서
받았습니다. 데이터를 열어보면, 모든 국가에 대한 정보가 포함되어 있고
열도 67개나 됩니다. 이 중 날짜(date), 한국(South Korea), 신규 확진자
수(new_cases)만 사용하겠습니다.

``` r
# 패키지 로드
library(tidyverse)
library(lubridate)

# 데이터 불러오기
data <- read.csv("owid-covid-data.csv")

# 데이터 열 확인
colnames(data)
```

    ##  [1] "iso_code"                                  
    ##  [2] "continent"                                 
    ##  [3] "location"                                  
    ##  [4] "date"                                      
    ##  [5] "total_cases"                               
    ##  [6] "new_cases"                                 
    ##  [7] "new_cases_smoothed"                        
    ##  [8] "total_deaths"                              
    ##  [9] "new_deaths"                                
    ## [10] "new_deaths_smoothed"                       
    ## [11] "total_cases_per_million"                   
    ## [12] "new_cases_per_million"                     
    ## [13] "new_cases_smoothed_per_million"            
    ## [14] "total_deaths_per_million"                  
    ## [15] "new_deaths_per_million"                    
    ## [16] "new_deaths_smoothed_per_million"           
    ## [17] "reproduction_rate"                         
    ## [18] "icu_patients"                              
    ## [19] "icu_patients_per_million"                  
    ## [20] "hosp_patients"                             
    ## [21] "hosp_patients_per_million"                 
    ## [22] "weekly_icu_admissions"                     
    ## [23] "weekly_icu_admissions_per_million"         
    ## [24] "weekly_hosp_admissions"                    
    ## [25] "weekly_hosp_admissions_per_million"        
    ## [26] "total_tests"                               
    ## [27] "new_tests"                                 
    ## [28] "total_tests_per_thousand"                  
    ## [29] "new_tests_per_thousand"                    
    ## [30] "new_tests_smoothed"                        
    ## [31] "new_tests_smoothed_per_thousand"           
    ## [32] "positive_rate"                             
    ## [33] "tests_per_case"                            
    ## [34] "tests_units"                               
    ## [35] "total_vaccinations"                        
    ## [36] "people_vaccinated"                         
    ## [37] "people_fully_vaccinated"                   
    ## [38] "total_boosters"                            
    ## [39] "new_vaccinations"                          
    ## [40] "new_vaccinations_smoothed"                 
    ## [41] "total_vaccinations_per_hundred"            
    ## [42] "people_vaccinated_per_hundred"             
    ## [43] "people_fully_vaccinated_per_hundred"       
    ## [44] "total_boosters_per_hundred"                
    ## [45] "new_vaccinations_smoothed_per_million"     
    ## [46] "new_people_vaccinated_smoothed"            
    ## [47] "new_people_vaccinated_smoothed_per_hundred"
    ## [48] "stringency_index"                          
    ## [49] "population_density"                        
    ## [50] "median_age"                                
    ## [51] "aged_65_older"                             
    ## [52] "aged_70_older"                             
    ## [53] "gdp_per_capita"                            
    ## [54] "extreme_poverty"                           
    ## [55] "cardiovasc_death_rate"                     
    ## [56] "diabetes_prevalence"                       
    ## [57] "female_smokers"                            
    ## [58] "male_smokers"                              
    ## [59] "handwashing_facilities"                    
    ## [60] "hospital_beds_per_thousand"                
    ## [61] "life_expectancy"                           
    ## [62] "human_development_index"                   
    ## [63] "population"                                
    ## [64] "excess_mortality_cumulative_absolute"      
    ## [65] "excess_mortality_cumulative"               
    ## [66] "excess_mortality"                          
    ## [67] "excess_mortality_cumulative_per_million"

``` r
# 한국 신규 확진자 수 데이터 추출
data2 <- data %>% 
  select(date, location, new_cases) %>% # date, location, new_cases 열 선택
  filter(location=="South Korea") # South Korea 자료 선택

# 데이터 요약
summary(data2)
```

    ##      date             location           new_cases     
    ##  Length:1034        Length:1034        Min.   :     0  
    ##  Class :character   Class :character   1st Qu.:   168  
    ##  Mode  :character   Mode  :character   Median :   967  
    ##                                        Mean   : 25733  
    ##                                        3rd Qu.: 13004  
    ##                                        Max.   :621317  
    ##                                        NA's   :1

데이터 요약을 보면, 이 데이터는 1,034일동안 한국의 신규 확진자 수 정보를 담고 있음을 알 수 있습니다. 신규 확진자 수가 적을 때는 0명, 많을 때는 621,317명까지 나온 날도 있습니다.

`lubridate`의 `ymd`를 사용해서 ‘년도-월-일’ 순서로 표기된
'문자형(character) 클래스'를 'Date 클래스'로 변경하겠습니다.
데이터 클래스를 바꾼 후 데이터를 요약하면, 이 자료가 2020년 1월 22일부터
2022년 11월 20일까지 해당하는 자료를 담고 있다는 것이 보입니다.

``` r
# date열 변경
data3 <- data2 %>% 
  mutate(date=ymd(date))

# 데이터 요약
summary(data3)
```

    ##       date              location           new_cases     
    ##  Min.   :2020-01-22   Length:1034        Min.   :     0  
    ##  1st Qu.:2020-10-06   Class :character   1st Qu.:   168  
    ##  Median :2021-06-21   Mode  :character   Median :   967  
    ##  Mean   :2021-06-21                      Mean   : 25733  
    ##  3rd Qu.:2022-03-06                      3rd Qu.: 13004  
    ##  Max.   :2022-11-20                      Max.   :621317  
    ##                                          NA's   :1

## x축이 날짜인 도표 그리기

`ggplot`으로 x축은 날짜, y축은 신규 확진자 수를 나타내는 도표를 그려
보겠습니다. 일반 도표를 그릴 때와 차이점은 `scale_x_continuous`나
`scale_x_discrete`이 아니라 `scale_x_date`를 사용한다는 점입니다.

``` r
ggplot(data=data3, aes(x=date, y=new_cases)) +
  geom_col() +
  scale_x_date(name="") +
  scale_y_continuous(name="신규 확진자 수(명)") +
  theme_bw()
```

<img src="{{ site.baseurl }}/assets/images/날짜-다루기/unnamed-chunk-4-1.png" width="70%" style="display: block; margin: auto;" />

만약 3개월 단위로 날짜를 표기하고 싶다면, 어떻게 해야 할까요?

`scale_x_date`의 `breaks` 인자를 활용하면 됩니다. 2020년 1월 20일부터 2022년 11월 20일까지 3개월 간격으로 떨어진 벡터는
`seq(ymd('2020-01-20'), ymd('2022-11-20'), by='3 month')`로 만들 수 있습니다. 이처럼 `lubridate` 패키지를 이용하면 날짜 시퀀스도 쉽게 생성할 수 있습니다.

``` r
ggplot(data=data3, aes(x=date, y=new_cases)) +
  geom_col() +
  scale_x_date(name="",
               breaks=seq(ymd('2020-01-20'),ymd('2022-11-20'), by='3 month')) +
  scale_y_continuous(name="신규 확진자 수(명)") +
  theme_bw()
```

<img src="{{ site.baseurl }}/assets/images/날짜-다루기/unnamed-chunk-5-1.png" width="70%" style="display: block; margin: auto;" />

도표를 보면, 날짜를 나타내는 텍스트 길이가 길어서 서로 겹치는 문제가
발생합니다. ‘년도-월-일’ 형식으로 적혀져 있으니, 년도 다음에 나오는
대쉬에서 줄 바꿈을 하면 문제가 해결될 것 같습니다. Date 클래스가 숫자형(double)이기 때문에, 문자형으로 바꾼 후 첫 번째 대쉬 뒤에서 줄 바꿈하겠습니다.

텍스트 줄 바꿈 관련
설명은 [축 텍스트 줄 바꿈
포스팅](https://themykim.github.io/docs/ggplot2%20%ED%8C%81/%EC%B6%95%20%ED%85%8D%EC%8A%A4%ED%8A%B8%20%EC%A4%84%20%EB%B0%94%EA%BF%88/)을
참고해 주세요. 

``` r
ggplot(data=data3, aes(x=date, y=new_cases)) +
  geom_col() +
  scale_x_date(name="",
              breaks=seq(ymd('2020-01-20'),ymd('2022-11-20'), by='3 month'),
              labels=function(x){sub("-", "-\n", as.character(x))}) + # 년도 다음 대쉬 뒤 줄 바꿈
  scale_y_continuous(name="신규 확진자 수(명)") +
  theme_bw()
```

<img src="{{ site.baseurl }}/assets/images/날짜-다루기/unnamed-chunk-6-1.png" width="70%" style="display: block; margin: auto;" />

줄 바꿈 말고도, 텍스트를 45도 회전하는 방법도 있습니다. 텍스트 회전은
`theme`의 `axis.text.x`로 설정할 수 있습니다. `hjust`와 `vjust`를
적절하게 설정해 줘야 축과 가까이 텍스트가 위치하게 됩니다.

``` r
ggplot(data=data3, aes(x=date, y=new_cases)) +
  geom_col() +
  scale_x_date(name="",
               breaks=seq(ymd('2020-01-20'),ymd('2022-11-20'), by='3 month')) +
  scale_y_continuous(name="신규 확진자 수(명)") +
  theme_bw() +
  theme(
    axis.text.x=element_text(angle=45, hjust=1, vjust=1)
  )
```

<img src="{{ site.baseurl }}/assets/images/날짜-다루기/unnamed-chunk-7-1.png" width="70%" style="display: block; margin: auto;" />

## 년월일을 년월로 변경하기

만약 우리나라 월 단위 신규 확진자 수 추이를 알고 싶다면, 어떻게 해야
할까요?

먼저 년월일 신규 확진자 수를 년월별로 합산해야겠죠. 기존 데이터에서
년월을 나타내는 열을 만든 후 년월을 기준으로 신규 확진자 수를
합치겠습니다. Date 클래스를 유지하면서 년월만 표기하는 방법이 없어서,
년월 열을 문자형 ‘년-월’ 포맷으로 만들어 줍니다.
`mutate(년월=format(date, "%y-%m"))`으로 년월을 나타내는 열을 만들어 줄
수 있습니다. `group_by`와 `summarise` 함수를 이용해서 년월을 기준으로
신규 확진자 수를 합산합니다.

``` r
data4 <- data3 %>% 
  mutate(년월=format(date, "%y-%m")) %>% 
  group_by(년월) %>% 
  summarise(new_cases=sum(new_cases, na.rm=T))

head(data4)
```

    ## # A tibble: 6 × 2
    ##   년월  new_cases
    ##   <chr>     <dbl>
    ## 1 20-01        10
    ## 2 20-02      3139
    ## 3 20-03      6636
    ## 4 20-04       988
    ## 5 20-05       729
    ## 6 20-06      1347

이제 도표를 그려보겠습니다. 년월은 이제 Date 클래스가 아니고 일반
문자형과 같습니다. `scale_x_date`가 아닌 `scale_x_discrete`을 사용해서
x축을 표현해 줘야 합니다. 그리고 `scale_x_discrete`의 `labels` 인자를 사용해서
'년-월'이 아닌 년 다음 줄 바꿈 후 월이 나오도록 해줬습니다.

``` r
ggplot(data=data4, aes(x=년월, y=new_cases)) +
  geom_col() +
  scale_x_discrete(name="",
                   labels=function(x){sub("-", "\n", x)}) +
  scale_y_continuous(name="신규 확진자 수(명)") +
  theme_bw()
```

<img src="{{ site.baseurl }}/assets/images/날짜-다루기/unnamed-chunk-9-1.png" width="70%" style="display: block; margin: auto;" />

도표를 보면, 모든 날짜에 년도와 월이 표기되어 있습니다. 모든 날짜에 년도를 함께 표기하기보다는 1월에만 년도를 표기하는 것이 좋을 것 같습니다. 앞서 작업한 것과 마차가지로, x축 라벨의 표기법은
`scale_x_discrete`의 `labels` 인자로 바꿔줄 수 있습니다. 아래 순서대로
코드를 작성하면 됩니다.

-   대쉬 뒤 줄 바꿈: `sub` 함수 이용
-   1월 해당 여부 파악: `grepl` 함수 이용
-   1월 해당하지 않으면 년도 삭제: `ifelse`, `sub` 함수 이용

``` r
ggplot(data=data4, aes(x=년월, y=new_cases)) +
  geom_col() +
  scale_x_discrete(name="",
                   labels=function(x){
                     y=sub("-", "\n", x)
                     ifelse(!grepl(".*(01)$", y), sub("^\\d{2}", "", y), y)
                   }) +
  scale_y_continuous(name="신규 확진자 수(명)") +
  theme_bw()
```

<img src="{{ site.baseurl }}/assets/images/날짜-다루기/unnamed-chunk-10-1.png" width="70%" style="display: block; margin: auto;" />

## 자잘한 수정하기

그래프를 좀 더 예쁘게 만들어 보겠습니다🐱

-   y축 숫자 단위 만명으로 수정하기
-   막대그래프가 x축과 맞닿도록 수정하기
-   막대그래프 위에 숫자 표시하기
-   글꼴, 색상 변경하기

``` r
# 글꼴 변경
library(showtext)

font_add_google("Noto Sans KR", "noto")

showtext_auto()
showtext_opts(dpi=300)

theme.size = 10
geom.text.size = theme.size/.pt 

# 그래프 작성
ggplot(data=data4, aes(x=년월, y=new_cases/10000, label=scales::comma(new_cases/10000, accuracy=1))) +
  geom_col(fill="#9AD1F5") +
  geom_text(size=geom.text.size, family="noto", vjust=-0.5) +
  scale_x_discrete(name="",
                   labels=function(x){
                     y=sub("-", "\n", x)
                     ifelse(!grepl(".*(01)$", y), sub("^\\d{2}", "", y), y)
                   }) +
  scale_y_continuous(name="신규 확진자 수(만명)",
                     labels=scales::comma_format(),
                     expand=expansion(mult=c(0, 0.2))) +
  theme_bw(base_size=theme.size, base_family="noto")
```

<img src="{{ site.baseurl }}/assets/images/날짜-다루기/unnamed-chunk-11-1.png" width="70%" style="display: block; margin: auto;" />
