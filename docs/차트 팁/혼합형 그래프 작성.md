---
layout: post_comments
title: 혼합형 그래프 작성
parent: 차트 팁
published: true
output:
  md_document:
    variant: markdown_github
    preserve_yaml: true
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, 
  encoding = encoding, 
  output_file=paste0(Sys.Date(), "-", sub(".Rmd", ".md",inputFile)), 
  output_dir = "C:/Users/MINYOUNG/projects/ggsave/docs/차트 팁") })
---
# {{ page.title }}
{: .no_toc }

## 데이터 준비

막대그래프와 선그래프를 조합한 혼합형 그래프를 그려야 할 때가 있습니다.
이번 포스팅에서는 `AirPassengers` 데이터를 활용하여 혼합형 그래프를
작성하는 과정을 단계별로 소개해 드립니다.

`AirPassengers` 데이터셋은 1949~1960년 월별 항공 승객 수를 제공하며,
단위는 천 명입니다. 이를 `ggplot2`로 시각화하기 위해 먼저 데이터를
변환해야 합니다. `AirPassengers`는 시계열 객체(ts)로, 그래프 작성을 위해
데이터프레임 객체로 변환해야 합니다. 데이터셋을 변환하고
필요한 열을 추가합니다.

``` r
# 패키지 로드
library(dplyr)

# 데이터 변환
data <- data.frame(matrix(AirPassengers, ncol = 12, byrow = TRUE))

colnames(data) <- seq(1, 12) # 열 이름 변경 (1~12월)

data <- data %>% mutate(년도 = seq(1949, 1960))

# 데이터 확인
head(data)
```

    ##     1   2   3   4   5   6   7   8   9  10  11  12 년도
    ## 1 112 118 132 129 121 135 148 148 136 119 104 118 1949
    ## 2 115 126 141 135 125 149 170 170 158 133 114 140 1950
    ## 3 145 150 178 163 172 178 199 199 184 162 146 166 1951
    ## 4 171 180 193 181 183 218 230 242 209 191 172 194 1952
    ## 5 196 196 236 235 229 243 264 272 237 211 180 201 1953
    ## 6 204 188 235 227 234 264 302 293 259 229 203 229 1954

년도별 승객 수를 합산하고, 전년 대비 승객 수 증감률을 계산합니다.

``` r
# 데이터 합산
data2 <- data %>% 
  mutate(
    `승객 수` = rowSums(across(1:12)),
    `전년 대비 승객 수 증감률` = (`승객 수` - lag(`승객 수`)) / lag(`승객 수`)
  ) %>% 
  select(년도, `승객 수`, `전년 대비 승객 수 증감률`)

# 데이터 확인
head(data2)
```

    ##   년도 승객 수 전년 대비 승객 수 증감률
    ## 1 1949    1520                       NA
    ## 2 1950    1676               0.10263158
    ## 3 1951    2042               0.21837709
    ## 4 1952    2364               0.15768854
    ## 5 1953    2700               0.14213198
    ## 6 1954    2867               0.06185185

## 혼합형 그래프 작성

년도별 승객 수를 나타내는 기본 막대그래프를 작성합니다.

``` r
# 패키지 로드
library(ggplot2)

# 막대그래프 생성
ggplot(data = data2) +
  geom_col(aes(x = 년도, y = `승객 수`), width = 0.6) +
  scale_x_continuous(n.breaks = 12) +
  theme_bw()
```

![](/assets/images/혼합형-그래프-작성/unnamed-chunk-3-1.png)

전년 대비 승객 수 증감률을 선그래프로 추가합니다. 그러나 값의 범위
차이로 인해 선그래프가 잘 보이지 않습니다.

``` r
# 선그래프 추가
ggplot(data = data2) +
  geom_col(aes(x = 년도, y = `승객 수`), width = 0.6) +
  geom_line(aes(x = 년도, y = `전년 대비 승객 수 증감률`)) +
  scale_x_continuous(n.breaks = 12) +
  theme_bw()
```

<img src="/assets/images/혼합형-그래프-작성/unnamed-chunk-4-1.png" width="70%" style="display: block; margin: auto;" />

적절한 상수를 곱해 선그래프의 위치를 조정합니다. 상수(`coeff`)는 승객
수와 증감률의 상대적 값을 고려해 계산합니다.

``` r
# 상수 계산
coeff <- max(data2$`승객 수`, na.rm = TRUE) / (max(data2$`전년 대비 승객 수 증감률`, na.rm = TRUE) * 2)

# 조정된 선그래프 생성
ggplot(data = data2) +
  geom_col(aes(x = 년도, y = `승객 수`), width = 0.6) +
  geom_line(aes(x = 년도, y = `전년 대비 승객 수 증감률` * coeff)) +
  scale_x_continuous(n.breaks = 12) +
  theme_bw()
```

<img src="/assets/images/혼합형-그래프-작성/unnamed-chunk-5-1.png" width="70%" style="display: block; margin: auto;" />

선그래프의 실제 값을 나타내기 위해 보조축을 추가합니다. 두 번째 y축은
`scale_y_continuous` 함수의 `sec.axis` 인자를 통해 추가할 수 있습니다.

``` r
# 이중축 추가
ggplot(data = data2) +
  geom_col(aes(x = 년도, y = `승객 수`), width = 0.6) +
  geom_line(aes(x = 년도, y = `전년 대비 승객 수 증감률` * coeff)) +
  scale_x_continuous(n.breaks = 12) +
  scale_y_continuous(
    name = "승객 수(천명)",
    labels = scales::comma_format(),
    sec.axis = sec_axis(~./coeff, name = "전년 대비 승객 수 증감률(%)",
                        labels = scales::percent_format())
  ) +
  theme_bw()
```

<img src="/assets/images/혼합형-그래프-작성/unnamed-chunk-6-1.png" width="70%" style="display: block; margin: auto;" />

그래프의 막대와 선의 의미를 명확히 하기 위해 범례를 추가합니다. 범례
제목과 위치를 조정하여 깔끔한 그래프를 완성합니다. 범례를 추가하기 위해
`geom_col(aes())` 안에 `fill="승객 수"`를 추가하고, `geom_line(aes())`
안에 `color="전년 대비 승객 수 증감률"`을 추가합니다. 각각의 색상을
지정하기 위해 `scale_fill_manual(values="gray40")`,
`scale_color_manual(values="gray70")`를 추가합니다.

`theme`에서 범례와 관련된 제목, 배경색, 위치, 여백을 조정해 줍니다.
여기서는 범례 제목, 배경색, 여백을 없앴고, 화면 상에서 좌측 상부에
범례가 위치하도록 조정했습니다.

``` r
ggplot(data = data2) +
  geom_col(aes(x = 년도, y = `승객 수`, fill = "승객 수"), width = 0.6) +
  geom_line(aes(x = 년도, y = `전년 대비 승객 수 증감률` * coeff, color = "전년 대비 승객 수 증감률")) +
  scale_fill_manual(values = "gray40") +
  scale_color_manual(values = "gray70") +
  scale_x_continuous(n.breaks = 12) +
  scale_y_continuous(
    name = "승객 수(천명)",
    labels = scales::comma_format(),
    sec.axis = sec_axis(~./coeff, name = "전년 대비 승객 수 증감률(%)",
                        labels = scales::percent_format())
  ) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.background = element_blank(),
    legend.position = c(0.20, 0.90),
    legend.margin = margin(0, 0, 0, 0)
  )
```

<img src="/assets/images/혼합형-그래프-작성/unnamed-chunk-7-1.png" width="70%" style="display: block; margin: auto;" />

혼합형 그래프를 활용하면 두 가지 데이터를 동시에 보여줄 수 있습니다. 위
코드를 참고해서 여러분 데이터에 맞는 혼합형 그래프를 작성해 보세요!
