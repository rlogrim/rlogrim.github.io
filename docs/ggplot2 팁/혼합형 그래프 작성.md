---
layout: post
title: 혼합형 그래프 작성
parent: ggplot2 팁
published: true
---

# {{ page.title }}
{: .no_toc }

## 목차
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## 데이터 준비

이번에는 월간 항공사 승객 수 1949\~1960(Monthly Airline Passenger
Numbers 1949-1960) 데이터셋을 이용하겠습니다.

데이터셋 행은 ‘년도’, 열은 ’월’을 나타내고, 승객 수는 천명 단위로
제공됩니다.

``` r
AirPassengers
```

    ##      Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
    ## 1949 112 118 132 129 121 135 148 148 136 119 104 118
    ## 1950 115 126 141 135 125 149 170 170 158 133 114 140
    ## 1951 145 150 178 163 172 178 199 199 184 162 146 166
    ## 1952 171 180 193 181 183 218 230 242 209 191 172 194
    ## 1953 196 196 236 235 229 243 264 272 237 211 180 201
    ## 1954 204 188 235 227 234 264 302 293 259 229 203 229
    ## 1955 242 233 267 269 270 315 364 347 312 274 237 278
    ## 1956 284 277 317 313 318 374 413 405 355 306 271 306
    ## 1957 315 301 356 348 355 422 465 467 404 347 305 336
    ## 1958 340 318 362 348 363 435 491 505 404 359 310 337
    ## 1959 360 342 406 396 420 472 548 559 463 407 362 405
    ## 1960 417 391 419 461 472 535 622 606 508 461 390 432

년도별 승객 수와 전년 대비 승객 수 증감률을 보여주는 그래프를 그리고
싶다면, 어떻게 해야 할까요?

년도별 승객 수는 막대그래프로, 전년 대비 승객 수 증감률은 선그래프로
표현하면 좋을 것 같습니다.

그래프를 그리기 전에 년도별 승객 수, 전년 대비 승객 수 증감률을
계산하겠습니다.

AirPassengers 데이터셋은 ts 객체(시계열 객체)라서 ggplot으로 그래프를
그리기에 적합하지 않아 데이터프레임 객체로 변환시켜 주겠습니다.

``` r
# 데이터 클래스 변환
data <- data.frame(matrix(AirPassengers, ncol=12, byrow=TRUE))

# 열 이름 변경
colnames(data) <- seq(1, 12)

# 년도를 나타내는 열 추가
data <- data %>% 
  mutate(년도=seq(1949, 1960))

head(data)
```

    ##     1   2   3   4   5   6   7   8   9  10  11  12 년도
    ## 1 112 118 132 129 121 135 148 148 136 119 104 118 1949
    ## 2 115 126 141 135 125 149 170 170 158 133 114 140 1950
    ## 3 145 150 178 163 172 178 199 199 184 162 146 166 1951
    ## 4 171 180 193 181 183 218 230 242 209 191 172 194 1952
    ## 5 196 196 236 235 229 243 264 272 237 211 180 201 1953
    ## 6 204 188 235 227 234 264 302 293 259 229 203 229 1954

년도별 승객 수를 합산하고, 전년 대비 승객 수 증감률을 계산하겠습니다.

`rowSums(across(1:12))`는 1\~12월 승객 수를 년도(행)별로 합산하는
함수입니다.

``lag(`승객 수`)``는 직전 년도 승객 수를 가리킵니다.

`select(!1:12)`는 1\~12월에 해당하는 열을 제외한 나머지 열인 년도, 승객
수, 전년 대비 승객 수 증감률만 선택하겠다는 의미입니다.

``` r
data2 <- data %>% 
  mutate(`승객 수`=rowSums(across(1:12)),
         `전년 대비 승객 수 증감률`=(`승객 수`-lag(`승객 수`))/lag(`승객 수`)) %>% 
  select(!1:12)

head(data2)
```

    ##   년도 승객 수 전년 대비 승객 수 증감률
    ## 1 1949    1520                       NA
    ## 2 1950    1676               0.10263158
    ## 3 1951    2042               0.21837709
    ## 4 1952    2364               0.15768854
    ## 5 1953    2700               0.14213198
    ## 6 1954    2867               0.06185185

## 혼합형 그래프 그리기

우선 년도별 승객 수를 보여주는 막대그래프를 그리겠습니다.

``` r
ggplot(data=data2) +
  geom_col(aes(x=년도, y=`승객 수`), width=0.6) +
  scale_x_continuous(n.breaks=12) +
  theme_bw()
```

<img src="/assets/images/혼합형-그래프-작성/unnamed-chunk-4-1.png" width="70%" style="display: block; margin: auto;" />

여기에 전년 대비 승객 수 증감률을 나타내는 선그래프를 추가하겠습니다.

`geom_line`으로 전년 대비 승객 수 증감률을 추가하니까 승객 수에 비해
증감률 수치가 매우 낮아 선그래프가 잘 보이지 않습니다.

``` r
ggplot(data=data2) +
  geom_col(aes(x=년도, y=`승객 수`), width=0.6) +
  geom_line(aes(x=년도, y=`전년 대비 승객 수 증감률`)) +
  scale_x_continuous(n.breaks=12) +
  theme_bw()
```

<img src="/assets/images/혼합형-그래프-작성/unnamed-chunk-5-1.png" width="70%" style="display: block; margin: auto;" />

막대그래프의 중간 정도 위치에 선그래프가 그려진다면 좋을 것 같습니다.

``geom_line(aes(x=년도, y=`전년 대비 승객 수 증감률`))``에서 ``y=`전년 대비 승객 수 증감률` ``에 적당한 값을 곱해주면 선그래프가 보이겠죠.

적당한 값은 전년 대비 승객 수 증감률에 곱했을 때 승객 수의 절반에
해당하는 값이 나오면 될 것 같습니다.

적당한 값을 coeff라고 하면, ‘전년 대비 승객 수 증감률’\*coeff=‘승객
수’/2가 되어야 겠죠.

즉, coeff는 ‘승객 수’/(‘전년 대비 승객 수 증감률’\*2)로 구할 수
있습니다.

``` r
coeff <- data2[2,"승객 수"]/(data2[2,"전년 대비 승객 수 증감률"]*2)

ggplot(data=data2) +
  geom_col(aes(x=년도, y=`승객 수`), width=0.6) +
  geom_line(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff)) +
  scale_x_continuous(n.breaks=12) +
  theme_bw()
```

<img src="/assets/images/혼합형-그래프-작성/unnamed-chunk-6-1.png" width="70%" style="display: block; margin: auto;" />

## 이중축(보조축) 추가하기

이렇게만 보여주면 선그래프가 어느 정도 값을 나타내는지 알 수 없으니,
전년 대비 승객 수 증감률에 해당하는 두 번째 y축을 추가해 주겠습니다.

두 번째 y축은 `scale_y_continuous` 함수의 `sec.axis` 인자를 통해 추가할
수 있습니다.

``` r
ggplot(data=data2) +
  geom_col(aes(x=년도, y=`승객 수`), width=0.6) +
  geom_line(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff)) +
  scale_x_continuous(n.breaks=12) +
  scale_y_continuous(
    sec.axis = sec_axis(~./coeff, name="전년 대비 승객 수 증감률(%)")
  ) +
  theme_bw()
```

<img src="/assets/images/혼합형-그래프-작성/unnamed-chunk-7-1.png" width="70%" style="display: block; margin: auto;" />

그런데 두 번째 y축을 보면, 증감률이 백분율로 표기되어 있지 않죠.

`sec_axis`에 `labels=scales::percent_format()`을 추가하여 백분율로
표기되도록 수정해 줍니다.

첫 번째 y축도 보면, 콤마와 단위가 표기되어 있지 않습니다.

이 문제는 `scale_y_continuous` 함수의 `name` 인자를 통해 축 제목을
수정하여 단위를 표기하고 `labels` 인자를 통해 콤마를 표기하여 해결할 수
있습니다.

``` r
ggplot(data=data2) +
  geom_col(aes(x=년도, y=`승객 수`), width=0.6) +
  geom_line(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff)) +
  scale_x_continuous(n.breaks=12) +
  scale_y_continuous(
    name="승객 수(천명)",
    labels=scales::comma_format(),
    sec.axis = sec_axis(~./coeff, name="전년 대비 승객 수 증감률(%)",
                        labels=scales::percent_format())
  ) +
  theme_bw()
```

<img src="/assets/images/혼합형-그래프-작성/unnamed-chunk-8-1.png" width="70%" style="display: block; margin: auto;" />

## 범례 추가하기

마지막으로, 막대그래프가 승객 수를, 선그래프가 전년 대비 승객 수
증감률을 나타낸다는 것을 명확히 하기 위해 범례를 추가하면 그래프가
완성됩니다!

범례를 추가하기 위해 `geom_col(aes())` 안에 `fill="승객 수"`를 추가하고,
`geom_line(aes())` 안에 `color="전년 대비 승객 수 증감률"`을 추가합니다.

각각의 색상을 지정하기 위해 `scale_fill_manual(values="gray40")`,
`scale_color_manual(values="gray70")`를 추가합니다.

`theme`에서 범례와 관련된 제목, 배경색, 위치, 여백을 조정해 줍니다.

여기서는 범례 제목, 배경색, 여백을 없앴고, 화면 상에서 좌측 상부에
범례가 위치하도록 조정했습니다.

``` r
ggplot(data=data2) +
  geom_col(aes(x=년도, y=`승객 수`, fill="승객 수"), width=0.6) +
  geom_line(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff, color="전년 대비 승객 수 증감률")) +
  scale_fill_manual(values="gray40") +
  scale_color_manual(values="gray70") +
  scale_x_continuous(n.breaks=12) +
  scale_y_continuous(
    name="승객 수(천명)",
    labels=scales::comma_format(),
    sec.axis = sec_axis(~./coeff, name="전년 대비 승객 수 증감률(%)",
                        labels=scales::percent_format())
  ) +
  theme_bw() +
  theme(
    legend.title=element_blank(),
    legend.background=element_blank(),
    legend.position=c(0.20, 0.90),
    legend.margin=margin(0, 0, 0, 0),
  )
```

<img src="/assets/images/혼합형-그래프-작성/unnamed-chunk-9-1.png" width="70%" style="display: block; margin: auto;" />
