---
layout: post
title: 숫자 포맷팅
parent: ggplot2 팁
published: true
---

# {{ page.title }}
{: .no_toc }

## 목차
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## 사전 작업

전에 그린 [혼합형 그래프](https://themykim.github.io/docs/ggplot2%20%ED%8C%81/%ED%98%BC%ED%95%A9%ED%98%95%20%EA%B7%B8%EB%9E%98%ED%94%84%20%EC%9E%91%EC%84%B1/)를
발전시켜 보겠습니다. 이전에 작성한 글을 참고해 주세요.

막대그래프, 선그래프 위에 텍스트를 아직 추가하지 않은 상태입니다.

`geom_text`를 사용해 텍스트를 추가하겠습니다.

출력된 그래프를 보면 텍스트가 추가되긴 했지만, 세자릿수마다 콤마가
표기되어 있지 않습니다.

그리고 선그래프 아래에 전년 대비 승객 수 증감률도 백분율로 표기되어 있지
않은데다가 소수점 아래 자릿수도 너무 깁니다.

``` r
coeff <- data2[2,"승객 수"]/(data2[2,"전년 대비 승객 수 증감률"]*2)

ggplot(data=data2) +
  geom_col(aes(x=년도, y=`승객 수`, fill="승객 수"), width=0.6) +
  geom_text(aes(x=년도, y=`승객 수`, label=`승객 수`), vjust=-1) + # 승객 수 텍스트 추가
  geom_line(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff, color="전년 대비 승객 수 증감률")) +
  geom_text(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff, label=`전년 대비 승객 수 증감률`), vjust=1.5) + # 전년 대비 승객 수 증감률 텍스트 추가
  scale_fill_manual(values="gray40") +
  scale_color_manual(values="gray70") +
  scale_x_continuous(n.breaks=12) +
  scale_y_continuous(
    name="승객 수(천명)",
    labels=scales::comma_format(),
    sec.axis = sec_axis(~./coeff, name="전년 대비 승객 수 증감률(%)",
                        labels=scales::percent_format())
  ) +
  theme_bw() +
  theme(
    legend.title=element_blank(),
    legend.background=element_blank(),
    legend.position=c(0.20, 0.90),
    legend.margin=margin(0, 0, 0, 0),
  )
```

<img src="/assets/images/숫자-포맷팅/unnamed-chunk-1-1.png" width="70%" style="display: block; margin: auto;" />

## 콤마 표기하기

승객 수 세자릿수마다 콤마를 찍어주도록 하겠습니다.

데이터를 수정하지 않고도 `scales` 패키지의 `comma` 함수로 숫자에 콤마를
추가해 줄 수 있습니다.

`` geom_text(aes(label=`승객 수`)) ``를
`` geom_text(aes(label=scales::comma(`승객 수`))) ``로 수정해 줍니다.

``` r
ggplot(data=data2) +
  geom_col(aes(x=년도, y=`승객 수`, fill="승객 수"), width=0.6) +
  geom_text(aes(x=년도, y=`승객 수`, label=scales::comma(`승객 수`)), vjust=-1) +
  geom_line(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff, color="전년 대비 승객 수 증감률")) +
  geom_text(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff, label=`전년 대비 승객 수 증감률`), vjust=1.5) +
  scale_fill_manual(values="gray40") +
  scale_color_manual(values="gray70") +
  scale_x_continuous(n.breaks=12) +
  scale_y_continuous(
    name="승객 수(천명)",
    labels=scales::comma_format(),
    sec.axis = sec_axis(~./coeff, name="전년 대비 승객 수 증감률(%)",
                        labels=scales::percent_format())
  ) +
  theme_bw() +
  theme(
    legend.title=element_blank(),
    legend.background=element_blank(),
    legend.position=c(0.20, 0.90),
    legend.margin=margin(0, 0, 0, 0),
  )
```

<img src="/assets/images/숫자-포맷팅/unnamed-chunk-2-1.png" width="70%" style="display: block; margin: auto;" />

## 백분율 표기하고 소수점 아래 자릿수 조정하기

다음으로, 전년 대비 승객 수 증감률을 백분율로 표기하고 소수점 아래
한자리까지만 나오도록 수정하겠습니다.

콤마 표기와 비슷하게 `scales` 패키지의 `percent` 함수를 이용하면, 숫자가
백분율로 나오게 만들 수 있습니다.

기존 코드에서 `` geom_text(aes(label=`전년 대비 승객 수 증감률`)) ``을
`` geom_text(aes(label=scales::percent(`전년 대비 승객 수 증감률`, accuracy=.1, suffix=""))) ``로
수정해 줍니다. `suffix=""`를 입력하지 않으면, % 단위까지 나옵니다.

``` r
ggplot(data=data2) +
  geom_col(aes(x=년도, y=`승객 수`, fill="승객 수"), width=0.6) +
  geom_text(aes(x=년도, y=`승객 수`, label=scales::comma(`승객 수`)), vjust=-1) +
  geom_line(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff, color="전년 대비 승객 수 증감률")) +
  geom_text(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff, label=scales::percent(`전년 대비 승객 수 증감률`, accuracy=.1, suffix="")), vjust=1.5) +
  scale_fill_manual(values="gray40") +
  scale_color_manual(values="gray70") +
  scale_x_continuous(n.breaks=12) +
  scale_y_continuous(
    name="승객 수(천명)",
    labels=scales::comma_format(),
    sec.axis = sec_axis(~./coeff, name="전년 대비 승객 수 증감률(%)",
                        labels=scales::percent_format())
  ) +
  theme_bw() +
  theme(
    legend.title=element_blank(),
    legend.background=element_blank(),
    legend.position=c(0.20, 0.90),
    legend.margin=margin(0, 0, 0, 0),
  )
```

<img src="/assets/images/숫자-포맷팅/unnamed-chunk-3-1.png" width="70%" style="display: block; margin: auto;" />

## 그외 자잘한 수정하기

그외 자잘한 수정이 필요한 부분은 아래와 같습니다.

1.  x축과 막대그래프 사이에 빈 공간이 있습니다.
2.  그래프가 잘려서 1960년 승객 수 텍스트가 안 보입니다.
3.  선그래프 위에 점이 추가되면 좋을 것 같습니다.
4.  첫 번째 y축에는 단위가 생략되었지만, 두 번째 y축에는 단위가 표기되어
    있습니다. 두 번째 y축 제목에 단위가 있으니 통일성을 위해 y축 상에는
    단위를 없애도 될 것 같습니다.
5.  범례 간 간격이 넓습니다.
6.  마지막으로, 그래프가 안 예쁩니다..😦

이 모든 수정사항을 반영하면 그래프 완성!

``` r
# 글꼴 변경
library(showtext)

font_add_google("Noto Sans KR", "noto")

showtext_auto()
showtext_opts(dpi=300)

theme.size = 10
geom.text.size = theme.size/.pt 

# 그래프 작성
ggplot(data=data2) +
  geom_col(aes(x=년도, y=`승객 수`, fill="승객 수"), width=0.6) +
  geom_text(aes(x=년도, y=`승객 수`, label=scales::comma(`승객 수`)), 
            vjust=-1,
            family="noto", size=geom.text.size) +
  geom_line(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff, color="전년 대비 승객 수 증감률"), size=1) +
  geom_point(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff, color="전년 대비 승객 수 증감률"), size=2) + # 3번 문제 해결
  geom_text(aes(x=년도, y=`전년 대비 승객 수 증감률`*coeff, label=scales::percent(`전년 대비 승객 수 증감률`, accuracy=.1, suffix="")), 
            vjust=ifelse(data2$`전년 대비 승객 수 증감률`<0.07, -1.0, 1.5),
            family="noto", size=geom.text.size) +
  scale_fill_manual(values="#9AD1F5") +
  scale_color_manual(values="#e25a6c") +
  scale_x_continuous(n.breaks=12) +
  scale_y_continuous(
    name="승객 수(천명)",
    labels=scales::comma_format(),
    expand=expansion(mult=c(0, 0.2)), # 1, 2번 문제 해결
    sec.axis = sec_axis(~./coeff, name="전년 대비 승객 수 증감률(%)",
                        labels=scales::percent_format(suffix="")) # 4번 문제 해결
  ) +
  theme_bw(base_family="noto", base_size=theme.size) +
  theme(
    panel.grid.major.x=element_blank(),
    panel.grid.minor.x=element_blank(),
    
    legend.title=element_blank(),
    legend.background=element_blank(),
    legend.key.size=unit(geom.text.size, "mm"),
    legend.text=element_text(size=rel(1)),
    legend.position=c(0.20, 0.90),
    legend.margin=margin(0, 0, 0, 0),
    legend.spacing.y=unit(0.5, "mm") # 5번 문제 해결
  )
```

<img src="/assets/images/숫자-포맷팅/unnamed-chunk-4-1.png" width="70%" style="display: block; margin: auto;" />
